# 対策に向けた決定事項整理

以下は、指摘された仕様差異・リスクおよびテスト評価に対して対策検討を進める際に決定しておくべきポイントの整理である。

## 仕様差異・リスクに関する決定事項

### 1. queueテーブルの公開日カラム表記揺れ
- **基準とする名称をどちらに揃えるか**: ドキュメント側の`queue.pub_data`に合わせるのか、実装・マイグレーション側の`pub_date`を正としてドキュメントを更新するのかを決定する。
- **移行方針**: 名称統一の結果、DBスキーマ変更やデータ移行が必要になる場合の対応有無とタイミングを決定する。
- **ドキュメント更新方針**: どの資料をどの範囲で修正するか、またリリースノートの扱いを決定する。

### 2. スクレイピングAPIエラー時のstatus_code保存
- **API呼び出しエラー時のキュー更新有無**: HTTP 4xx/5xx応答の際に`status_code`をキューへ記録するか、あるいは現在通り保存しない方針とするか決定する。
- **保存する場合の実装方法**: 例外ハンドリングの範囲（`call_scrape_api`内で完結させるのか、呼び出し側で制御するのか）や保存する追加情報（レスポンスボディ等）の有無を決定する。
- **運用上の通知・再試行戦略**: エラー状態をキューに残した際の再実行条件や監視方法を定義する。

### 3. `gen_random_uuid()`利用とpgcrypto拡張
- **拡張機能の有効化方法**: `pgcrypto`をマイグレーションで有効化するのか、DBセットアップ手順に明示するのかを決定する。
- **UUID生成方式の見直し**: `pgcrypto`に依存しないUUID生成手段へ置き換える可能性を検討し、採用可否を判断する。
- **既存環境への影響範囲**: 変更による既存データベース・CI環境への影響とロールアウト手順を決定する。

### 4. fetch_rssテスト内の`super::`利用
- **コード規約順守の優先度**: テストコードに対しても厳密に規約を適用するか、例外を設けるかを決める。
- **修正方針**: 規約順守とする場合、`use`宣言で明示的にインポートし直す範囲やリファクタリングの規模を決定する。

### 5. YAML詳細設定の未使用問題
- **未使用フィールドの扱い**: 現仕様で未使用の`wait_for_selector`や`timeout`を削除するか、将来拡張を見越して実装に組み込むかを決定する。
- **API仕様との整合性**: API側とのインターフェース調整が必要か、仕様変更をどのタイミングで反映するかを判断する。

## テスト評価に関する決定事項

### 6. fetch_contentテストの継続方針
- **既存テストの維持・拡張範囲**: 現状のwiremock＋実DBテストをどこまで維持するか、追加シナリオ（例: ネットワークタイムアウト、レスポンス変形）を増やすかを決定する。
- **テスト実行条件**: `TEST_DATABASE_URL`依存テストの実行を標準化するか、任意実行とするかの方針を決める。

### 7. fetch_rssの主要フローテスト追加
- **追加すべきテストケース**: RSS取得処理・DB upsertのモック戦略（実DBかインメモリか）および重複更新検証などの具体的なテストケースを決定する。
- **テストデータの用意方法**: モックフィードの作成場所・形式、CIでの取り扱いを決定する。

### 8. DB接続テストの拡充
- **失敗ケースのテスト要否**: `db::create_pool`について、失敗時メッセージやパラメータ検証をテストすべきかを決める。
- **環境変数依存の扱い**: テスト時の環境変数設定ポリシーと、CI/CDでの実行可否を決定する。

---

上記の決定事項について優先度や依存関係を整理した上で対応方針を確定することで、仕様差異の解消とテストカバレッジ向上に向けた具体的な対策計画を策定しやすくなる。
